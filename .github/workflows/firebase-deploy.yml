name: Deploy to Firebase Hosting

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: |
          # Run tests with a hard timeout to ensure exit
          npm run test:run &
          TEST_PID=$!
          EXIT_CODE=0
          TIMED_OUT=false
          
          # Wait for up to 5 minutes
          for i in {1..300}; do
            if ! kill -0 $TEST_PID 2>/dev/null; then
              # Process has exited, capture its exit code
              wait $TEST_PID
              EXIT_CODE=$?
              break
            fi
            sleep 1
          done
          
          # Check if loop completed without process exiting (timeout scenario)
          if kill -0 $TEST_PID 2>/dev/null; then
            echo "Tests timed out after 5 minutes"
            kill -9 $TEST_PID 2>/dev/null || true
            TIMED_OUT=true
          else
            # Process exited during or after loop - ensure we have its exit code
            if [ "$EXIT_CODE" -eq 0 ] && [ "$i" -eq 300 ]; then
              # Loop completed naturally, check if process just exited
              wait $TEST_PID 2>/dev/null || EXIT_CODE=$?
            fi
          fi
          
          # Exit with appropriate code
          if [ "$TIMED_OUT" = true ]; then
            exit 1
          else
            exit $EXIT_CODE
          fi
        timeout-minutes: 10

  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type Check
        run: npm run check

      - name: Validate Firebase Config
        run: npm run check:firebase
        env:
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}

      - name: Check Dynatrace Configuration
        run: |
          echo "â„¹ï¸  Checking Dynatrace configuration (informational)..."
          if [ -n "$VITE_DYNATRACE_SCRIPT_URL" ]; then
            echo "âœ… Dynatrace script URL is configured"
          else
            echo "âš ï¸  Dynatrace is not configured - monitoring will be disabled"
            echo ""
            echo "To enable Dynatrace monitoring:"
            echo "1. Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo "2. Click 'New repository secret'"
            echo "3. Name: VITE_DYNATRACE_SCRIPT_URL"
            echo "4. Value: Your Dynatrace RUM script URL (https://js-cdn.dynatrace.com/jstag/...)"
            echo ""
            echo "To get your Dynatrace script URL:"
            echo "  a. Sign up at https://www.dynatrace.com/trial (free trial available)"
            echo "  b. Create a web application in your Dynatrace environment"
            echo "  c. Go to: Applications & Microservices > Web applications > Your app"
            echo "  d. Click '...' > Edit > Setup > Instrumentation code"
            echo "  e. Copy the complete src URL from the <script> tag"
            echo ""
            echo "ðŸ“š For detailed setup: docs/setup/dynatrace.md"
            echo ""
            echo "âš ï¸  Deployment will proceed without Dynatrace monitoring"
          fi
        env:
          VITE_DYNATRACE_SCRIPT_URL: ${{ secrets.VITE_DYNATRACE_SCRIPT_URL }}

      - name: Validate Dynatrace Config
        run: npm run check:dynatrace
        env:
          VITE_DYNATRACE_SCRIPT_URL: ${{ secrets.VITE_DYNATRACE_SCRIPT_URL }}
          VITE_ENABLE_DYNATRACE: ${{ secrets.VITE_ENABLE_DYNATRACE }}

      - name: Build
        run: npm run build:firebase
        env:
          NODE_ENV: production
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}
          VITE_DYNATRACE_SCRIPT_URL: ${{ secrets.VITE_DYNATRACE_SCRIPT_URL }}
          VITE_ENABLE_DYNATRACE: ${{ secrets.VITE_ENABLE_DYNATRACE }}

      - name: Deploy Firestore Rules and Indexes
        run: |
          # Create temporary credentials file
          CREDS_FILE=$(mktemp)
          printf '%s' "$FIREBASE_SERVICE_ACCOUNT" > "$CREDS_FILE"
          export GOOGLE_APPLICATION_CREDENTIALS="$CREDS_FILE"
          
          # Deploy Firestore rules and indexes
          npx firebase deploy --only firestore:rules,firestore:indexes --project "$FIREBASE_PROJECT_ID" --non-interactive
          
          # Securely clean up credentials file
          shred -u "$CREDS_FILE" 2>/dev/null || rm -f "$CREDS_FILE"
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0.10.0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          channelId: live
          projectId: ${{ secrets.FIREBASE_PROJECT_ID }}
